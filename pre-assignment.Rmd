---
title: "pre-assignment"
author: "WoodyLIver"
date: "27 04 2021"
output:
  html_document: default
  pdf_document: default
---
# Libraries
```{r}
library(openxlsx)
library(tseries)
library(forecast)
library(EnvStats)
library(lmtest)
```

# Read data
```{r cars}
data <- read.xlsx("Lions_Den_data.xlsx")
ts <- ts(unlist(data[2]), start=c(1994, 7), frequency=12)
plot(ts)
```

# Decomposition
```{r}
decompose <- decompose(ts, "additive")
plot(decompose)
```

# Outliers
Test on raw data that the winter 2006 does not match. We have tried to manipulate data(differentiation, decomposition, etc) in order to get more outliers, but there were no reasonable results.
```{r}
plot(ts, type="o")
rosnerTest(ts, k = 3)
```
# Autocorrelation and stationarity analysis
We can see that time-series is already stationary and is slightly correlated with itself 12 month earlier.
```{r}
#autocorrelation
acf(ts, lag.max = 12)
#stationary test
adf.test(ts)
```
## PREDICTION
# Delete outlier
```{r}
ts_ <- ts
plot(window(ts_, 2003, 2008), type="l", ylab="coal usage")
ts_[137:145] = ts_[137:145] * 0.6
lines(window(ts_, 2003, 2008), type="l", col="blue")
```
# Perform new decomposition.
```{r}
decompose_ <- decompose(ts_, "additive")
plot(decompose_)
```
# Predict trend
```{r}
tsTrend <- ts(decompose_$trend, start=c(1994, 7), frequency=12)
fitARIMA <- arima(tsTrend, order=c(1,1,1),seasonal = list(order = c(1,0,0), period = 12),method="ML")
coeftest(fitARIMA) 
yTrend <- predict(fitARIMA,n.ahead = 12)$pred
cTrend <- ts(
  c(tsTrend, yTrend),
  start=start(tsTrend),
  frequency=12
)
plot(cTrend, type="s", ylab="coal usage trend")
```
# Extract seasonal
```{r}
ySeasonal <- window(decompose$seasonal, start=2020, end=c(2020,12))
```
# Predict coal usage
```{r}
Y <- ts(as.numeric(yTrend) + as.numeric(ySeasonal),
        star=start(yTrend), frequency=12)
TS <- ts(c(ts, Y), start=start(ts), frequency=12)
plot(TS, type="s", ylab="coal usage",
     main="history and prediction")
lines(Y, type="s", col="blue")
lines(yTrend, col="red")
Y
```